!function(t){var e={};function s(i){if(e[i])return e[i].exports;var h=e[i]={i:i,l:!1,exports:{}};return t[i].call(h.exports,h,h.exports,s),h.l=!0,h.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)s.d(i,h,function(e){return t[e]}.bind(null,h));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t="none"){this.state=t}toString(){return String(this.state)}copy(){return new i(String(this.state))}setBlack(){this.state="black"}setWhite(){this.state="white"}setState(t){this.state=t}getState(){return String(this.state)}isBlack(){return"black"===this.state}isWhite(){return"white"===this.state}isNone(){return"none"===this.state}clear(){this.state="none"}static playerReverse(t){return"black"===t?"white":"white"===t?"black":t}}class h{constructor(t){this.data=new Array(t);for(let e=0;e<this.data.length;e++)this.data[e]=new Array(t);for(let e=0;e<t;e++)for(let s=0;s<t;s++)this.data[e][s]=new i;this.n=t,this.whiteCount=12,this.blackCount=12;for(let t=1;t<=6;t++)this.setWhiteAt(t,0),this.setWhiteAt(t,7),this.setBlackAt(0,t),this.setBlackAt(7,t)}copy(){const t=new h(this.n);for(let e=0;e<this.n;e++)for(let s=0;s<this.n;s++)t.data[e][s].setState(this.data[e][s].state);return t.n=Number(this.n),t.blackCount=Number(this.blackCount),t.whiteCount=Number(this.whiteCount),t}setBlackAt(t,e){if(this.data[t][e].isWhite())this.whiteCount--;else{if(!this.data[t][e].isNone())throw new Error("ChessBoard::setBlackAt() Exception");this.blackCount}this.data[t][e].setBlack()}setWhiteAt(t,e){if(this.data[t][e].isBlack())this.blackCount--;else{if(!this.data[t][e].isNone())throw new Error("ChessBoard::setWhiteAt() Exception");this.whiteCount}this.data[t][e].setWhite()}setAt(t,e,s){"black"===s?this.setBlackAt(t,e):"white"===s&&this.setWhiteAt(t,e)}resetAt(t,e){this.data[t][e].clear()}moveFromTo(t,e,s,i){this.setAt(s,i,this.data[t][e].state),this.resetAt(t,e)}getUpdownChessCountFrom(t,e){let s=0;for(let t=0;t<this.n;t++)this.data[t][e].isNone()||s++;return s}getLeftrightChessCountFrom(t,e){let s=0;for(let e=0;e<this.n;e++)this.data[t][e].isNone()||s++;return s}getDiagonalChessCountFrom(t,e){let s=0;for(;0!==t&&0!==e;)t--,e--;for(let i=0;t+i<this.n&&e+i<this.n;i++)this.data[t+i][e+i].isNone()||s++;return s}getCounterDiagonalChessCountFrom(t,e){let s=0;for(;t!==this.n-1&&0!==e;)t++,e--;for(;t>=0&&e<this.n;)this.data[t][e].isNone()||s++,t--,e++;return s}computeDestinationFrom(t,e,s,h,o){let r=!0,l=this.data[t][e].toString(),n=i.playerReverse(l);const a=Number(t),c=Number(e);for(let i=0;i<o-1;i++)if(e+=h,(t+=s)<0||t>=this.n||e<0||e>=this.n||this.data[t][e].toString()===n){r=!1;break}if(r&&(e+=h,((t+=s)<0||t>=this.n||e<0||e>=this.n||this.data[t][e].toString()===l)&&(r=!1)),r){let s=this.copy();return s.moveFromTo(a,c,t,e),{fromRow:a,fromCol:c,toRow:t,toCol:e,chessBoard:s}}return null}getAllNextStepAt(t,e){const s=new Array;if(!this.data[t][e].isNone()){let[i,h,o,r]=[this.getUpdownChessCountFrom(t,e),this.getLeftrightChessCountFrom(t,e),this.getDiagonalChessCountFrom(t,e),this.getCounterDiagonalChessCountFrom(t,e)],l=this.computeDestinationFrom(t,e,-1,0,i);null!==l&&s.push(l);let n=this.computeDestinationFrom(t,e,1,0,i);null!==n&&s.push(n);let a=this.computeDestinationFrom(t,e,0,-1,h);null!==a&&s.push(a);let c=this.computeDestinationFrom(t,e,0,1,h);null!==c&&s.push(c);let d=this.computeDestinationFrom(t,e,-1,-1,o);null!==d&&s.push(d);let u=this.computeDestinationFrom(t,e,1,1,o);null!==u&&s.push(u);let f=this.computeDestinationFrom(t,e,-1,1,r);null!==f&&s.push(f);let p=this.computeDestinationFrom(t,e,1,-1,r);null!==p&&s.push(p)}return s}getAllNextStep(t){const e=new Array;if("none"!==t)for(let s=0;s<this.n;s++)for(let i=0;i<this.n;i++)if(this.data[s][i].toString()===t){const t=this.getAllNextStepAt(s,i);e.push(...t)}return e}getRandomNextChessBoard(t){let e=this.getAllNextStep(t),{fromRow:s,fromCol:i,toRow:h,toCol:o,chessBoard:r}=e[Math.floor(Math.random()*e.length)];return r}BFSHelper(t,e,s,i,h){return s>=0&&s<this.n&&i>=0&&i<this.n&&this.data[s][i].state===h&&!e[s][i]?(e[s][i]=!0,t.push({row:s,col:i}),1):0}BFS(t,e,s){let i=this.data[t][e].state,h=0,o=[];for(o.push({row:t,col:e}),s[t][e]=!0,h++;o.length;){const t=o.shift();let{row:e,col:r}=t,l=e,n=r;h+=this.BFSHelper(o,s,l-1,n,i),h+=this.BFSHelper(o,s,l+1,n,i),h+=this.BFSHelper(o,s,l,n-1,i),h+=this.BFSHelper(o,s,l,n+1,i),h+=this.BFSHelper(o,s,l-1,n-1,i),h+=this.BFSHelper(o,s,l+1,n+1,i),h+=this.BFSHelper(o,s,l-1,n+1,i),h+=this.BFSHelper(o,s,l+1,n-1,i)}return h}isConnect(t){let e=!1,s=new Array(this.n);for(let t=0;t<this.n;t++)s[t]=new Array(this.n),s[t].fill(!1,0,this.end);if("none"!==t){let i=0;i="black"===t?this.blackCount:this.whiteCount;for(let h=0;h<this.n;h++){for(let o=0;o<this.n;o++)if(this.data[h][o].toString()===t){e=this.BFS(h,o,s)===i;break}if(e)break}}return e}getCC(t){let e=0,s=0,i=0;i="black"===t?this.blackCount:this.whiteCount;let h=new Array(this.n);for(let t=0;t<this.n;t++)h[t]=new Array(this.n),h[t].fill(!1,0,this.end);for(let o=0;o<this.n;o++){for(let r=0;r<this.n;r++)if(this.data[o][r].toString()===t&&!h[o][r]){if(e+=1,(s+=this.BFS(o,r,h))==i)break;s>i&&console.log("connect error")}if(s==i)break}return e}isTerminal(t){let e="none",s=this.getAllNextStep("black").length,i=this.getAllNextStep("white").length;return 1===this.whiteCount?e="black":1===this.blackCount?e="white":this.isConnect("black")?e="black":this.isConnect("white")?e="white":0===s?e=i>0?"white":t:0===i&&(e=s>0?"black":lstStepPalyer),e}isGood(){return"none"}}var o=h,r=1.414;class l{constructor(t,e){this.chessBoard=t,this.player=e,this.visits=0,this.scores=0,this.uct=0}copy(){const t=new l(this.chessBoard.copy(),String(this.player));return t.visits=Number(this.visits),t.scores=Number(this.scores),t.uct=Number(this.uct),t}static playerReverse(t){return"white"===t?"black":"black"===t?"white":t}}class n{constructor(t,e){this.state=t,this.parent=e,this.children=new Array,this.bestChild=null,this.evaluatedChildren=new Set}copy(){const t=new n(this.state.copy(),this.parent);null===this.bestChild&&0===this.children.length||alert("shallow copy happened!");for(let e=0;e<this.children.length;e++)t.children.push(this.children[e]);t.bestChild=null!==this.bestChild?this.bestChild.copy():null;for(let e of this.evaluatedChildren)t.evaluatedChildren.add(e);return t}isExtended(){return this.children.length&&this.children.length===this.evaluatedChildren.size}addChild(t){this.children.push(t)}getChildren(){return this.children}getUCT(){if(null!==this.parent&&this.state.visits>0){let t=this.parent.state.visits;return this.state.scores/this.state.visits+r*Math.sqrt(Math.log(t)/this.state.visits)}throw new Exception("MCTNode::getUCT() Exception")}updateState(t,e){this.state.visits+=t,this.state.scores+=e,this.state.uct=this.getUCT()}}var a=class{constructor(t,e){let s=new l(t,e);this.root=new n(s,null),this.rootPlayer=e,this.winner=l.playerReverse(e),this.firstStepMap=new Array}extend(t){if(!t.children.length){let e=t.state.chessBoard,s=t.state.player,i=l.playerReverse(s),h=e.getAllNextStep(i);for(let e of h){let{fromRow:s,fromCol:h,toRow:o,toCol:r,chessBoard:a}=e,c=new l(a,i),d=new n(c,t);t.addChild(d),null===t.parent&&this.firstStepMap.push({fromRow:s,fromCol:h,toRow:o,toCol:r})}}let e=null;for(let s=0;s<t.children.length;s++)if(!t.evaluatedChildren.has(s)){t.evaluatedChildren.add(s),e=t.children[s];break}return e}simulate(t){let e=t.state.player,s=this.winner,i=t.state.chessBoard;for(;"none"===i.isGood()&&"none"===i.isTerminal(e)&&(e=l.playerReverse(e),"none"===(i=i.getRandomNextChessBoard(e)).isTerminal(e));)e=l.playerReverse(e),i=i.getRandomNextChessBoard(e);return"none"!==i.isTerminal(e)?Number(i.isTerminal(e)===s):Number(i.isGood()===s)}search(){if("none"!==this.root.state.chessBoard.isTerminal(this.rootPlayer))return;let t=this.root;for(t.state.visits++;t.isExtended();)(t=t.bestChild).state.visits++;let e=this.extend(t),s=0,i=null;null===e?(s=Number(t.state.chessBoard.isTerminal(this.rootPlayer)===this.winner),i=t):(s=this.simulate(e.copy()),e.state.visits+=1,i=e);let h=i;for(;null!==h.parent;){h.updateState(0,s);let t=h.parent;for(let e of t.children)if(e!==h&&e.state.visits){e.updateState(0,0);let s=e.state.uct;(null===t.bestChild||t.bestChild.state.uct<s)&&(t.bestChild=e)}h=t}}generate(){let t=(new Date).getTime(),e=new Date,s=e.getTime();for(;Number(s-t)<=55e3;)this.search(),s=(e=new Date).getTime();let i=this.root.children,h=i.reduce((t,e,s,i)=>e.state.visits>i[t].state.visits?s:t,0);return i.forEach((t,e,s)=>{console.log(t.state.visits,t.state.scores,t.state.uct)}),{chessBoard:i[h].state.chessBoard,firstStep:this.firstStepMap[h],duration:s-t}}};new class{constructor(t){this.canvasId=t,this.resetData()}resetData(){var t=document.documentElement||document.body,e=Math.min(t.clientWidth,t.clientHeight);this.chesses=null,this.rowCount=8,this.colCount=this.rowCount,this.cellWidth=e/this.rowCount,this.width=this.rowCount*this.cellWidth,this.height=this.width,this.R=.4*this.cellWidth,this.positive="black",this.canvas=document.getElementById(this.canvasId),this.ctx=this.canvas.getContext("2d"),this.chessBoard=new o(8),this.init()}init(){this.initCanvas(),this.renderUI()}initCanvas(){this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.addEventListener("click",t=>{let e=this.canvas.getBoundingClientRect(),s=Math.floor((t.clientX-e.left)/this.cellWidth),i=Math.floor((t.clientY-e.top)/this.cellWidth);if(this.fromRow||this.fromCol)if(this.fromRow===i&&this.fromCol===s)this.fromRow=null,this.fromCol=null,this.renderUI();else if(this.chessBoard.data[i][s].state===this.positive){this.renderUI(),this.fromRow=i,this.fromCol=s,this.allNextStep=this.chessBoard.getAllNextStepAt(i,s);for(let t of this.allNextStep){let{fromRow:e,fromCol:s,toRow:i,toCol:h,chessBoard:o}=t;this.drawNextPosition(i,h)}}else if(this.validateStep(i,s)){this.chessBoard.moveFromTo(this.fromRow,this.fromCol,i,s),this.renderUI(),console.log("winner:",this.chessBoard.isTerminal(this.positive)),this.fromRow=null,this.fromCol=null;let t=this.chessBoard.isTerminal(this.positive);if("none"!==t)return void window.setTimeout(()=>{alert("游戏结束, "+t+"胜"),this.chessBoard=new o(8),this.renderUI()},1);window.setTimeout(()=>{let e=new a(this.chessBoard,this.positive),{chessBoard:s,firstStep:i,duration:h}=e.generate();this.chessBoard=s,this.renderUI(),this.drawLastPosition(i.fromRow,i.fromCol),document.getElementById("textDiv").innerHTML=h+"ms","none"===(t=this.chessBoard.isTerminal(this.positive))||window.setTimeout(()=>{alert("游戏结束, "+t+"胜"),this.chessBoard=new o(8),this.renderUI()},1)},1),console.log("after AI winner:",this.chessBoard.isTerminal(this.positive)),console.log("black CC:",this.chessBoard.getCC("black")),console.log("white CC:",this.chessBoard.getCC("white")),console.log("black count:",this.chessBoard.blackCount),console.log("white count:",this.chessBoard.whiteCount)}else alert("落子错误");else if(this.chessBoard.data[i][s].state===this.positive){this.renderUI(),this.fromRow=i,this.fromCol=s,this.allNextStep=this.chessBoard.getAllNextStepAt(i,s);for(let t of this.allNextStep){let{fromRow:e,fromCol:s,toRow:i,toCol:h,chessBoard:o}=t;this.drawNextPosition(i,h)}}},!1)}renderUI(){return this.ctx.clearRect(0,0,this.width,this.height),this.drawMap(),this.drawChesses(this.chessBoard),!0}drawDot(t,e,s,i){let h=e*this.cellWidth+this.cellWidth/2,o=t*this.cellWidth+this.cellWidth/2;this.ctx.beginPath(),this.ctx.arc(h,o,s,0,2*Math.PI),this.ctx.closePath(),this.ctx.fillStyle=i,this.ctx.fill()}drawMap(){this.ctx.beginPath(),this.ctx.rect(0,0,this.width,this.height),this.ctx.closePath(),this.ctx.fillStyle="#f4a460",this.ctx.fill(),this.ctx.beginPath();for(let t=0;t<this.rowCount;t++)this.ctx.moveTo(0,this.cellWidth*t),this.ctx.lineTo(this.cellWidth*this.rowCount,this.cellWidth*t);this.ctx.strokeStyle="blue",this.ctx.stroke(),this.ctx.beginPath();for(let t=0;t<this.colCount;t++)this.ctx.moveTo(this.cellWidth*t,0),this.ctx.lineTo(this.cellWidth*t,this.cellWidth*this.colCount);this.ctx.strokeStyle="blue",this.ctx.stroke()}drawChesses(t){this.chesses=t.data;for(let t=0;t<this.chesses.length;t++)for(let e=0;e<this.chesses[t].length;e++)"string"==typeof this.chesses[t][e]&&(this.chesses[t][e]=JSON.parse(this.chesses[t][e])),"black"===this.chesses[t][e].state?this.drawDot(t,e,this.R,"black"):"white"===this.chesses[t][e].state&&this.drawDot(t,e,this.R,"white")}drawNextPosition(t,e){let s=e*this.cellWidth+this.cellWidth/2,i=t*this.cellWidth+this.cellWidth/2;this.ctx.beginPath(),this.ctx.arc(s,i,this.R,0,2*Math.PI),this.ctx.closePath(),this.ctx.strokeStyle="green",this.ctx.stroke()}drawLastPosition(t,e){let s=e*this.cellWidth+this.cellWidth/2,i=t*this.cellWidth+this.cellWidth/2;this.ctx.beginPath(),this.ctx.arc(s,i,this.R,0,2*Math.PI),this.ctx.closePath(),this.ctx.strokeStyle="red",this.ctx.stroke()}validateStep(t,e){let s=!1;for(let i of this.allNextStep){let{fromRow:h,fromCol:o,toRow:r,toCol:l,chessBoard:n}=i;if(r===t&&l===e){s=!0;break}}return s}}("blackWhite")}]);